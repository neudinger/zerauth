<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>FIDO2 WebAuthn Demo</title>
    <style>
        body {
            font-family: sans-serif;
            max-width: 600px;
            margin: 40px auto;
        }

        h2 {
            border-bottom: 2px solid #eee;
            padding-bottom: 5px;
        }

        input,
        button {
            padding: 10px;
            margin: 5px 0;
            width: 100%;
            box-sizing: border-box;
        }

        .container {
            border: 1px solid #ccc;
            padding: 20px;
            margin-top: 20px;
        }

        #message {
            margin-top: 15px;
            padding: 10px;
            border: 1px solid;
            display: none;
        }
    </style>
</head>

<body>
    <h1>FIDO2/WebAuthn Registration & Auth</h1>

    <div class="container">
        <h2>ðŸ”‘ Registration</h2>
        <input type="text" id="reg-username" placeholder="Enter new username for registration">
        <button onclick="startRegistration()">Register FIDO2 Key</button>
    </div>

    <div class="container">
        <h2>ðŸ”’ Authentication</h2>
        <input type="text" id="auth-username" placeholder="Enter existing username for login">
        <button onclick="startAuthentication()">Authenticate with FIDO2 Key</button>
    </div>

    <div id="message"></div>

    <script>
        const RP_ID = "localhost"; // Must match the backend RP_ID

        // Helper function to convert base64url string to ArrayBuffer
        function base64urlToBuffer(base66url) {
            const padding = '=='.substring(0, (4 - base66url.length % 4) % 4);
            const base64 = (base66url + padding).replace(/-/g, '+').replace(/_/g, '/');
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray.buffer;
        }

        // Helper function to convert ArrayBuffer to base64url string
        function bufferToBase64url(buffer) {
            const bytes = new Uint8Array(buffer);
            let str = '';
            for (const char of bytes) {
                str += String.fromCharCode(char);
            }
            return window.btoa(str).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
        }

        // Display messages
        function showMessage(text, isError = false) {
            const msgEl = document.getElementById('message');
            msgEl.textContent = text;
            msgEl.style.display = 'block';
            msgEl.style.borderColor = isError ? 'red' : 'green';
            msgEl.style.color = isError ? 'red' : 'green';
        }

        // --- REGISTRATION FLOW ---
        async function startRegistration() {
            const username = document.getElementById('reg-username').value;
            if (!username) {
                showMessage("Please enter a username for registration.", true);
                console.warn("Registration aborted: missing username");
                return;
            }

            showMessage("Starting registration...");
            console.log(`[REG] Starting registration for user: ${username}`);

            try {
                // 1. Get challenge/options from backend
                console.log("[REG] Requesting options from /register/begin...");
                const response = await fetch('/register/begin', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username })
                });

                if (!response.ok) {
                    const error = await response.json();
                    console.error("[REG] /register/begin failed:", error);
                    throw new Error(error.detail || `HTTP Error: ${response.status}`);
                }

                let options = await response.json();
                console.log("[REG] Received options from server:", options);

                // 2. Convert base64url strings in options to ArrayBuffers for the WebAuthn API
                options.challenge = base64urlToBuffer(options.challenge);
                options.user.id = base64urlToBuffer(options.user.id);
                // The pubKeyCredParams is already fine

                console.log("[REG] Converted options for WebAuthn API:", options);

                // 3. Call the WebAuthn API to create the credential
                console.log("[REG] Calling navigator.credentials.create()...");
                const credential = await navigator.credentials.create({ publicKey: options });
                console.log("[REG] Credential created successfully:", credential);

                // 4. Convert ArrayBuffers in the response back to base64url for the backend
                const responseData = {
                    id: credential.id,
                    rawId: bufferToBase64url(credential.rawId),
                    response: {
                        clientDataJSON: bufferToBase64url(credential.response.clientDataJSON),
                        attestationObject: bufferToBase64url(credential.response.attestationObject),
                    },
                    type: credential.type,
                };

                // Transports are optional
                if (credential.response.getTransports) {
                    responseData.response.transports = credential.response.getTransports();
                }

                console.log("[REG] Prepared response data for server verification:", responseData);

                // 5. Send the response back to the backend for verification
                console.log("[REG] Sending credential to /register/complete...");
                const verifyResponse = await fetch('/register/complete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(responseData)
                });

                if (!verifyResponse.ok) {
                    const error = await verifyResponse.json();
                    console.error("[REG] /register/complete failed:", error);
                    throw new Error(error.detail || `Verification Failed: ${verifyResponse.status}`);
                }

                const result = await verifyResponse.json();
                console.log("[REG] Registration complete. Result:", result);
                showMessage(result.message);

            } catch (error) {
                showMessage(`Registration failed: ${error.message}`, true);
                console.error('[REG] Registration Error:', error);
            }
        }


        // --- AUTHENTICATION FLOW ---
        async function startAuthentication() {
            const username = document.getElementById('auth-username').value;
            if (!username) {
                showMessage("Please enter a username for authentication.", true);
                console.warn("Authentication aborted: missing username");
                return;
            }

            showMessage("Starting authentication...");
            console.log(`[AUTH] Starting authentication for user: ${username}`);

            try {
                // 1. Get challenge/options from backend
                console.log("[AUTH] Requesting options from /auth/begin...");
                const response = await fetch('/auth/begin', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username })
                });

                if (!response.ok) {
                    const error = await response.json();
                    console.error("[AUTH] /auth/begin failed:", error);
                    throw new Error(error.detail || `HTTP Error: ${response.status}`);
                }

                let options = await response.json();
                console.log("[AUTH] Received options from server:", options);

                // 2. Convert base64url strings in options to ArrayBuffers
                options.challenge = base64urlToBuffer(options.challenge);
                // Credential IDs must also be converted to ArrayBuffer
                if (options.allowCredentials) {
                    options.allowCredentials = options.allowCredentials.map(cred => ({
                        ...cred,
                        id: base64urlToBuffer(cred.id)
                    }));
                }

                console.log("[AUTH] Converted options for WebAuthn API:", options);

                // 3. Call the WebAuthn API to get the assertion
                console.log("[AUTH] Calling navigator.credentials.get()...");
                const assertion = await navigator.credentials.get({ publicKey: options });
                console.log("[AUTH] Assertion received successfully:", assertion);

                // 4. Convert ArrayBuffers in the response back to base64url for the backend
                const responseData = {
                    id: assertion.id,
                    rawId: bufferToBase64url(assertion.rawId),
                    response: {
                        clientDataJSON: bufferToBase64url(assertion.response.clientDataJSON),
                        authenticatorData: bufferToBase64url(assertion.response.authenticatorData),
                        signature: bufferToBase64url(assertion.response.signature),
                        userHandle: assertion.response.userHandle ? bufferToBase64url(assertion.response.userHandle) : null,
                    },
                    type: assertion.type,
                };

                console.log("[AUTH] Prepared response data for server verification:", responseData);

                // 5. Send the response back to the backend for verification
                console.log("[AUTH] Sending assertion to /auth/complete...");
                const verifyResponse = await fetch('/auth/complete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(responseData)
                });

                if (!verifyResponse.ok) {
                    const error = await verifyResponse.json();
                    console.error("[AUTH] /auth/complete failed:", error);
                    throw new Error(error.detail || `Verification Failed: ${verifyResponse.status}`);
                }

                const result = await verifyResponse.json();
                console.log("[AUTH] Authentication complete. Result:", result);
                showMessage(result.message);

            } catch (error) {
                showMessage(`Authentication failed: ${error.message}`, true);
                console.error('[AUTH] Authentication Error:', error);
            }
        }
    </script>
</body>

</html>